<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8">
    <meta http-equiv="cache-control" content="max-age=0"/>
    <meta http-equiv="cache-control" content="no-cache"/>
    <meta http-equiv="expires" content="0"/>
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT"/>
    <meta http-equiv="pragma" content="no-cache"/>
    <title>Reality Editor</title>

    <!-- Sets initial viewport load and disables zooming  -->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <script src="../../index.js"></script>

    <!-- Include the compiled Ratchet CSS -->
    <link href="../../../thirdPartyCode/css/ratchet.css" rel="stylesheet">
    <link href="../../../thirdPartyCode/css/ratchet-theme-ios.css" rel="stylesheet">

    <!-- Include the compiled Ratchet JS -->
    <script src="../../../thirdPartyCode/js/ratchet.min.js"></script>
    <script src="states.js"></script>

    <style>
        #foundObjectsTitle {
            display: flex;
            flex-direction: row;
            left: 70px;
            width: calc(100% - 100px);
        }
        .flexItem {
            flex-grow: 1;
        }
        .flexItemWide {
            flex-grow: 2;
        }
        .infoRow {
            display: flex;
            flex-direction: 1;
            width: 100%;
        }
    </style>
</head>
<body style="background-color: #efeff4;">
<div style="position: absolute; right: 0; width: 65px; top:0; bottom: 0; background-color: #222222"></div>
<div>

    <header class="bar bar-nav" style="right:65px; left:0">
        <a class="" href="index.html" data-ignore="push">
            <button class="btn btn-link btn-nav pull-left">
                <span class="icon icon-left-nav"></span>
                Back
            </button></a>
        <div id="foundObjectsTitle" class="title">
            <div class="flexItemWide">Object</div>
            <div class="flexItem">Version</div>
            <div class="flexItem">IP</div>
            <div class="flexItem">Nodes</div>
            <div class="flexItem">Links</div>
        </div>
<!--            <h1 class="title">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-->
<!--                Object-->
<!--                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-->
<!--                Version&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-->
<!--                IP-->
<!--                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-->
<!--                Nodes &nbsp;&nbsp;&nbsp;Links&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</h1>-->
    </header>

    <!-- Wrap all non-bar HTML in the .content div (this is actually what scrolls) -->
    <div class="content" style="right:65px;">
        <div class="card">
            <ul class="table-view" id="objectList"></ul>
        </div>
    </div>

    <template id="tableEntry">
            <li class="table-view-cell table-view-cell"></li>
    </template>

    <template id="row">
        <div>
            <div class="infoRow" style="height: 30px;">
                <img class="flexItem media-object pull-left" src="../../../svg/object.svg" style="width: 26px; height: 26px; margin-top: -2px; margin-bottom: -5px">
                <div class="flexItemWide rowName" style="width: 130px; overflow: hidden; font-size: large"></div>
                <div style="width: 70px; text-align: center">
                    <span class="badge rowVersion" style="font-size: large"></span>
                </div>
                <div class="flexItem" style="width: 140px; text-align: center">
                    <span class="badge rowIP" style="font-size: large"></span>
                </div>
                <div class="flexItem" style="width: 40px; text-align: center">
                    <span class="badge rowNodes" style="font-size: large"></span>
                </div>
                <div class="flexItem" style="width: 40px; text-align: center">
                    <span class="badge rowLinks" style="font-size: large"></span>
                </div>
            </div>
        </div>
    </template>

</div>

<script>
    var previousFoundObjects = null; // stores stringified foundObjects so that we can detect changes over time

    // because this is a self-contained iframe, only way to receive data about found objects is using a message listener
    window.addEventListener("message", function (e) {
        var msg = JSON.parse(e.data);
        if (msg.getObjects) {
            realityEditor.gui.settings.getObjectsFunction(msg.getObjects);
        }
    });

    /**
     * This gets triggered by a POST message coming into this iframe from the parent window.
     * It receives a set of information for each discovered object, and renders a table displaying the information.
     * This should get called on a (infrequent) loop as long as the iframe is open, so that it doesn't keep stale data.
     * @param {Object.<string, {name: string, version: string, ip: string, initialized: boolean, frames: Object}>} msg
     */
    realityEditor.gui.settings.getObjectsFunction = function (msg) {
        // don't re-render if nothing has changed
        if (previousFoundObjects && previousFoundObjects === JSON.stringify(msg)) {
            return;
        }

        document.getElementById("objectList").innerHTML = '';
        for (var objectKey in msg) {
            createObjectEntry(objectKey, msg[objectKey]);
        }

        previousFoundObjects = JSON.stringify(msg);
    };

    /**
     * Builds an HTML element displaying all information for this object and its frames, and adds it to the table.
     * @param {string} objectKey
     * @param {{name: string, version: string, ip: string, initialized: boolean, frames: Object}} objectInfo
     */
    function createObjectEntry(objectKey, objectInfo) {
        var entry = document.createElement('li');
        entry.className = 'table-view-cell';
        entry.id = 'foundObject' + objectKey;

        var tableEntry = document.getElementsByTagName('template')['tableEntry'].content.cloneNode(true);

        // add a row for the object with the object name, version, and IP
        var objectRow = document.getElementsByTagName('template')['row'].content.cloneNode(true);

        if (objectInfo.isAnchor) { // different icon for anchor
            objectRow.querySelector('.media-object').src = '../../../svg/foundObjectAnchor.svg';
        }

        objectRow.querySelector('.rowName').innerText = objectInfo.name;
        objectRow.querySelector('.rowVersion').innerText = objectInfo.version;
        objectRow.querySelector('.rowIP').innerText = objectInfo.ip;
        objectRow.querySelector('.rowNodes').style.visibility = 'hidden';
        objectRow.querySelector('.rowLinks').style.visibility = 'hidden';

        tableEntry.querySelector('.table-view-cell').appendChild(objectRow);

        // add additional rows in this table entry for each of this object's frames
        for (var frameKey in objectInfo.frames) {
            var frameInfo = objectInfo.frames[frameKey];
            var frameRow = createFrameRow(frameKey, frameInfo);
            tableEntry.querySelector('.table-view-cell').appendChild(frameRow);
        }

        // give visual feedback if an object's Vuforia target was not initialized correctly
        if (!objectInfo.initialized && !objectInfo.isAnchor) {
            tableEntry.querySelector('.table-view-cell').style.opacity = 0.5;
            tableEntry.querySelector('.table-view-cell').style.color = 'rgb(255,0,124)';
        }

        document.getElementById("objectList").appendChild(tableEntry);
    }

    /**
     * Helper function to build the HTML element for a particular frame
     * @param {string} frameKey
     * @param {{name: string, nodes: number, links: number}} frameInfo
     * @return {Node} - returns the created element so it can be added to its parent's table entry
     */
    function createFrameRow(frameKey, frameInfo) {
        var frameRow = document.getElementsByTagName('template')['row'].content.cloneNode(true);

        // indent frames underneath their objects
        frameRow.querySelector('.infoRow').style.marginLeft = '10px'; // dont hide overflow for frames, just objects
        frameRow.querySelector('.infoRow').style.widthc = 'calc(100% - 20px)';
        // dont hide overflow for frames, just objects

        frameRow.querySelector('.media-object').src = '../../../svg/foundObjectFrame.svg'; // different icon for frame
        frameRow.querySelector('.rowName').innerText = frameInfo.name;
        frameRow.querySelector('.rowName').style.overflow = ''; // dont hide overflow for frames, just objects
        frameRow.querySelector('.rowVersion').style.visibility = 'hidden';
        frameRow.querySelector('.rowIP').style.visibility = 'hidden';
        frameRow.querySelector('.rowNodes').innerText = frameInfo.nodes; // number of nodes on this frame
        frameRow.querySelector('.rowLinks').innerText = frameInfo.links; // number of links starting from this frame
        return frameRow;
    }

    // this is triggered on a 1 second interval by the included script, ./index.js, to ask for updated object data
    realityEditor.gui.settings.callObjects = function () {
        parent.postMessage(
            JSON.stringify({
                settings: {
                    getObjects: true
                }
            }), "*")
    };
    realityEditor.gui.settings.callObjects(); // also get the data immediately when the iframe loads

</script>
<script src="index.js"></script>
</body>
</html>
